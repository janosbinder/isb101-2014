---
title: "Rmarkdown and data import"
author: "E. Koncina, A. Ginolhac"
date: "09 January 2017"
output:
  iosp::ioslides_plus:
    box_colours:
      bg-blue-white: ["white", "#005C99"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{css, echo = FALSE}
/* my css codes. Some might get integrated in a future iosp version...*/

article .my-flex > .box-body > p {
  display: flex;
  display: -webkit-flex;
  align-items: center;
  -webkit-align-items: center;
  justify-content: space-around;
  -webkit-justify-content: space-around;
  font-size: 50px;
}

.box li {
  line-height: 1.1em; /* should be optimized in the main iosp css... */
}

article .code-transparent > pre {
  background: none;
  /*border-left: none;*/
}

.code-transparent pre {
  color: #c7254e;
  background: none;
  border-left: none;
  padding-left: 50px;
}

.center img {
  display: block;
  margin: auto;
  float: none;
}
```

# Rmarkdown

## Learning objectives {.vs2}

### You will learn to: {.box-10 .offset-1 .bg-red .icon}

![](img/00/kt.png)

- use the markdown syntax
- create _Rmarkdown_ documents
- define the output format you expect to render
- use the interactive RStudio interface to
    + create your documents
    + insert R code
    + build your final document

## RMarkdown

### Why using `rmarkdown`?{.box-10 .offset-1 .bg-blue .icon}

![](img/03/rmarkdown_output.png)

- write detailed reports
- ensure reproducibility
- keep track of your analyses
- comment/describe each step of your analysis
- export a single (Rmd) document to various formats (Pdf, Html...)
- text file that can be managed by a version control system (like [git](https://git-scm.com/))

### Rmarkdown {.box-8 .offset-2 .bg-red .my-flex .vs1}

![](img/00/logo_r.png) + ![](img/03/knit.png) + ![](img/03/logo_md.png)

## Markdown {.build}

**Markdown** is used to **format the text**

### Markup language {.box-6 .bg-blue}

- Such as Xml, HTML
- A coding system used to structure text
- Uses markup tags (_e.g._ `<h1></h1>` in HTML)

### HTML {.box-6 .bg-green .my_code .stretch}

```
<!DOCTYPE html>
<html>
<body>

<h1>This is a heading</h1>

<p>This is some text in a paragraph.</p>

</body>
</html>
```

### **Lightweight** markup language{.box-6 .bg-blue}

- Easy to read and write as it uses simple tags (_e.g._ `#`)

### MD {.box-6 .bg-green .my_code .stretch}

```
# This is a heading

This is some text in a paragraph
```

## Markdown | common text formatting **tags**

### Headers{.box-6 .bg-pink2 .stretch}

- Levels are defined using `#`, `##`, `###` ...

### Text style{.box-6 .bg-aquamarine2 .stretch}

- **bold** (`**`This will be bold`**`)
- *italic* (`*`This will be italic`*`)

### Links and images{.box-6 .bg-yellow .stretch}

- `[description](http://example.com)`
- `![](path/to/image.jpg)`

### Verbatim code{.box-6 .bg-blue .stretch .code-transparent} 
- `code` (` ` `This will be some inline coding stuff` ` `)
- triple backticks are delimiting code blocks

~~~
```
This is *verbatim* code
# Even headers are not interpreted
```
~~~

### Rmarkdown cheatsheet {.box-12 .bg-green .icon .stretch}

![](img/03/rmarkdown_cheatsheet.png)

- Have a look at the online documents on the [Rmarkdown website](http://rmarkdown.rstudio.com/lesson-8.html)
- Use the Cheatsheet in the `Help > Cheatsheets` menu.


## Exercise | Markdown{.bg-green .vs3}

### Learn to use the markdown syntax{.box-8 .offset-2 .bg-white .icon}

![](img/03/logo_md.png)

Before writing your own Rmarkdown document, use the excellent ressource on
[commonmark.org](http://commonmark.org/help/tutorial/) to learn the basics of markdown formatting.


<span class = "vs2 small">An alternative online ressource can be found on [www.markdowntutorial.com](http://www.markdowntutorial.com/)</span>




## Including _R_ code

### Rmarkdown{.box-5 .bg-red .icon}

![](img/00/logo_rmarkdown.png)

- extends markdown
- allows to integrate code chunks that will be interpreted
    + **R code**
    + bash
    + python
    + css
    + ...

### Knitr{.box-7 .bg-red .icon}

![](img/00/logo_knitr.png)

- R chunks are extracted, interpreted separately
- The result is formatted (with or without the source code) and integrated into the markdown document
- The markdown document is converted to the desired document format (Pdf, Html...)
- Relies on the powerful [pandoc](http://pandoc.org/) converter
- Fully integrated in Rstudio (Knit button)

```{block, type = "center"}
![](img/03/rstudio_knit.png)
```

## Rmarkdown document | Create, step 1{.nvs1}

###{.col-10 .offset-1}

![](img/03/rstudio_rmd_create_1.jpg)

## Rmarkdown document | Create, step 2{.nvs1}

###{.col-10 .offset-1}

![](img/03/rstudio_rmd_create_2.jpg)

## Rmarkdown document | Structure

A Rmarkdown document document contains 3 elements:

###{.col-6}

![](img/03/rmd_example.png)

###{.col-6}

- A **<span class = "red">YAML header</span>** to define document wide options
- Text which is formatted using the **<span class = "blue">markdown</span>** syntax
- **<span class = "green">chunks</span>** containing the code to be interpreted by _R_ 

## Rmarkdown document | Navigation

###{.col-8 .offset-2}

![](img/03/rstudio_index.jpg)

## Rmarkdown document | Insert R code {.build}

### Inserting a code chunk {.box-6 .offset-3 .bg-blue .center}

![](img/03/rstudio_chunk_add.png)

### {.box-6 .offset-3 .bg-white .center}

![](img/03/chunk_example.png)

## Rmarkdown document | Insert R code {.build}

### R code chunks {.box-10 .offset-1 .bg-blue .center}

![](img/03/chunk_example.png)

- chunks are defined between two lines starting with a 3 backticks tag (` ``` `)
- curly brackets define how to interprete the content (_R_ code but other languages such as Python are also supported)
  + ` ```{r} ` is the minimum to define a starting _R_ chunk
  + can contain more options (name of chunk, whether to show it or not, evaluate it or not)

### Inline code {.box-10 .bg-blue .offset-1}

To integrate small pieces of _R_ codes

- Use backticks (` ` `) combined to the keyword r (`` `r '\x60r <your R code>\x60'` ``)
- Example: type in ``1 + 1 = `r '\x60r 1+1\x60'` `` to render 1 + 1 = `r 1+1`.


## Rmarkdown document | generate

### Creating the output document {.box-6 .offset-3 .bg-blue .center .vs2}

- use the integrated **Knit** button.
- call `rmarkdown::render()`

![](img/03/rstudio_knit.png)

## Popular output formats

### HTML {.box-6 .bg-green .stretch}

- fast rendering
- by default embeds binaries (pictures etc.)
- customise styles using your own `css` files
    + change headers
    + fonts
    + ...

### Pdf {.box-6 .bg-red .stretch}

- single file
- preserves original aspect
- requires $\LaTeX$
- customise using your own
    + $\LaTeX$ document class
    + pandoc template (`.tex`)

### Word document {.box-6 .offset-3 .bg-blue .stretch}

- Widely used
- Easily editable
- Collaborate with people not using Rmarkdown
- Prepare even scientific manuscripts suitable for submission

## Growing variety of output formats

### Output documents {.box-10 .offset-1 .bg-blue .icon}

![](img/03/rmarkdown_output.png)

- Look on the [rmarkdown website](http://rmarkdown.rstudio.com/gallery.html)
- Documents (HTML, PDF, MS Word...)
- **interactive** documents (`shiny` package)
- websites (like the [Biostat2](http://biostat2.uni.lu) or [rmarkdown](http://rmarkdown.rstudio.com) sites)

### Books{.box-6 .bg-green .icon}

![](img/00/book.png)

- Bookdown package. Go on the [website](https://bookdown.org/yihui/bookdown/) to learn more about it.
- Generate books as PDF, EPUB or MOBI files.
- Have a look at the [R for Data Science](http://r4ds.had.co.nz/) website.
    
### Slideshow presentations {.box-6 .bg-yellow}

- **ioslides_presentation** (HTML)
    + [iosp](https://github.com/koncina/iosp) used for this presentation.
- slidy_presentation (HTML)
- beamer_presentation (pdf, $\LaTeX$)
- ...

## Wrap up {.vs2}

### You learned to: {.box-10 .offset-1 .bg-red .icon}

![](img/00/kt.png)

- create _Rmarkdown_ documents
- format your text using the markdown syntax
- insert your R code in chunks
- adapt some rendering options of R code chunks
- define the output format you expect to render
- use the interactive RStudio interface to
    + create your documents
    + insert R code
    + build your final document

# Import data using `readr`

## Learning objectives {.vs2}

### You will learn to: {.box-10 .offset-1 .bg-red .icon}

![](img/00/kt.png)

- use `readr` to import your data into _R_
- use the interactive RStudio interface to visualise your data
- appreciate tibbles

## Importing data{.vs3 .build}

###{.box-6 .bg-blue .offset-0 .stretch}

- Represents probably the first step of your work
- R can handle multiple data types
    + flat files (`.csv`, `.tsv`, ...)
    + excel files (`.xls`, `.xlsx`)
    + foreign statistical formats (`.sas` from SAS, `.sav` from SPSS, `.dta` from Stata)
    + databases (SQL, SQLite ...)
    
### Tidyverse implementation {.box-6 .bg-yellow .offset-0 .icon}

![](img/00/logo_tidyverse.png)

- R base already provides functions for text files (_i.e._ `read.csv()`, `read.delim()`)
- tidyverse redefines these functions:
    + **speed**
    + **characters are not coerced to factors by default**
    + generates tibbles

## Tibbles{.build}

### Tibbles{.box-8 .bg-blue .offset-2 .icon}

![](img/00/logo_tibble.png)

- have a refined print method that shows only the first 10 rows.
- show all the columns that fit on screen and list the name of remaining ones.
- each column reports its type.
- makes it much easier to work with large data.

### Hint {.box-6 .offset-3 .bg-yellow .icon-small .vs1}

![](img/00/tip.png)

Use `as_tibble()` to convert a `data.frame` to a tibble

## Tibbles | `tibble` vs `data.frame`

### {.col-8 .offset-2 .compact-output}

```{r, class = "build", title = "`data.frame`"}
iris
```

## Tibbles | `tibble` vs `data.frame`{} {.build}

### {.col-8 .compact-output}

```{r, title = "`tibble`"}
as_tibble(iris)
```

### {.col-4 .bg-cobalt .compact-output}

```{r, echo = 2, title = "`tibble` adjusts to width"}
options(tibble.width = 30)
as_tibble(iris)
options(tibble.width = NULL)
```

### tibble printing enhancements {.box-6 .offset-3 .bg-yellow}

- column type is visible
- shows only the first 10 rows
- shows only the columns that fit on the screen

## Create tibbles{.build}

### `tibble()`{} {.box-6 .bg-blue}

- similar to `base::data.frame()` but
    + does not coerce characters to factors
    + does not change column names
    + never uses rownames

%end%

```{r, row = c(6, 6)}
data.frame(`bad name` = 1:4,
           x = rep(letters[1:2], 2)) %>%
  str()
```

```{r, row = c(6, 6)}
tibble(`bad name` = 1:4,
       x = rep(letters[1:2], 2)) %>%
  str()
```

## The tidyverse packages to import your data

### Tidyverse packages to import your data {.box-10 .offset-1 .bg-blue .icon}

![](img/00/logo_readr.png)

Seven file formats are supported by the readr package:

- `read_csv()`: comma separated (CSV) files
- `read_tsv()`: tab separated files
- `read_delim()`: general delimited files
- `read_fwf()`: fixed width files
- `read_table()`: tabular files where colums are separated by white-space.
- `read_log()`: web log files

### readxl {.box-6 .bg-green .icon}

![](img/00/logo_readxl.png)

To import excel files (`.xls` and `.xlsx`):

- `read_excel()`
    + `read_xls()`
    + `read_xlsx()`
    
### haven {.box-6 .bg-red .icon .stretch}

![](img/00/logo_haven.png)

- `read_sas()` for SAS
- `read_sav()` for SPSS
- `read_dta()` for Stata


# Importing flat files

## Reading flat files{.build .bg-green}

```{css, echo = FALSE}
.flatfile pre {
  background: white;
  width: 100%;
}
```


### Flat file example: _mtcars.csv_{.box-10 .offset-1 .bg-blue-white .flatfile}

- Create a new project (finding your files will be easier)
- Download the [`mtcars.csv`](data/mtcars.csv) file to your project folder (using your favourite browser)
- Open the file with a text viewer and have a look at its content

```
"mpg","cyl","disp","hp","drat","wt","qsec","vs","am","gear","carb"
21,6,160,110,3.9,2.62,16.46,0,1,4,4
21,6,160,110,3.9,2.875,17.02,0,1,4,4
22.8,4,108,93,3.85,2.32,18.61,1,1,4,1
21.4,6,258,110,3.08,3.215,19.44,1,0,3,1
18.7,8,360,175,3.15,3.44,17.02,0,0,3,2
...
```

## Rstudio data import | interactive call to `readr`

```{css, echo = FALSE}
/* Center two images in boxes*/
.center-pair p {
  display: flex;
  display: -webkit-flex;
}

.center-pair p > img {
  max-width: 45%;
  margin: auto;
}
```

### Import button{.box-8 .offset-2 .bg-blue .center-pair}

- Use the `Import Dataset` button in the upper right panel or click on the file in the lower right panel

![](img/03/rstudio_import_option_1.jpg) ![](img/03/rstudio_import_option_2.jpg)

- Will interactively select the appropriate function
- Copy paste the generated command to your Rmarkdown document

## Exercise {.bg-green}

### Import the `mtcars.csv` dataset {.box-8 .offset-2 .bg-white}

- Use the interactive `Import Dataset` button to import the `mtcars.csv` file.

## Rstudio data import | preview window{.bg-green}

###{.col-10 .offset-1}

![](img/03/rstudio_import_preview.jpg)

## Reading flat files | comma separated values

### `read_csv()`{}{.box-10 .offset-1 .bg-blue}

- to import **comma separated values**
- is able to read **local** and **remote** files
- is able to read compressed files (`.zip`, `.gz`, ...)

## Reading flat files | comma separated values

### {.col-10 .offset-1 .compact-output}

```{r, title = "Using `read_csv()`"}
read_csv("data/mtcars.csv")
```

## Column types

### Column types{.box-7 .bg-blue}

- are guessed from the **1000** first rows
    + adjustable `guess_max` option
- guessed types are displayed as a _message_
- to hide this message:
    + **lazy method 1**: set `message = FALSE` in your rmarkdown chunk option.
    + **lazy method 2**: set `col_types = cols()`
    + Hadley Wickham recommends to adjust the `col_types` to avoid any problem
    
### {.col-5 .stretch}

```{r, echo = FALSE, title = "Message"}
dummy <- readr_example("mtcars.csv") %>% # Generates the path to the example file
  read_csv()
```

## Column types

### The `col_types` argument {.box-8 .offset-2 .bg-blue}

```{r}
read_csv("data/example.csv",
         col_types = cols())
```

- Let's start with a [file](data/example.csv) containing only 3 columns: `animal`, `colour` and `value`
- Column types are specified using the `cols()` function
- Types can be one of `double`, `integer`, `character`, `logical`, `factor`, `date`, `datetime` or `time`

## Column types

```{css, echo = FALSE}
.chunk > .r-output > pre {
  font-size: 14px;
}
```

### Explicit method {.box-6 .bg-blue .col-list .c2}

Using a function defining each type:

- `col_double()`
- `col_integer()`
- `col_character()`
- `col_logical()`
- `col_factor()`
- `col_date()`
- `col_datetime()`
- `col_time()`

Or telling to **guess** or **skip** a column:

- `col_guess()`
- `col_skip()`

### Example {.box-6 .bg-green}

```{r}
read_csv("data/example.csv",
         col_types = cols(
           animal = col_character(),
           colour = col_character(),
           value = col_integer()
         ))
```

## Column types {.build}

### Compact shortcuts {.box-6 .bg-blue .col-list .c2}

Using a single character to define each type:

- `c` = character
- `i` = integer
- `n` = number
- `d` = double
- `l` = logical
- `D` = date
- `T` = date time
- `t` = time

Or telling to **guess** or **skip** a column:

- `?` = guess
- `_` or `-` = skip

### Example {.box-6 .bg-green .stretch}

```{r}
read_csv("data/example.csv",
         col_types = cols(
           animal = "c",
           colour = "c",
           value = "i"
         ))
```

### Even more compact {.box-8 .offset-2 .bg-yellow}

```{r, eval = FALSE}
read_csv("data/example.csv", col_types = "cci")
```

- Use the single character code in the order of appearance of each column

## Exercise {.bg-green .vs3}

```{r, echo = FALSE}
options(tibble.print_min = 4)
```

### Override the detected column types {.box-10 .offset-1 .bg-white}

- import the `example.csv` file **but**
    + **skip** the `colour` column
    + read in the `value` column as **double**

## Exercise {.bg-green}

### {.col-12}

```{r, row = c(9, 3), title = "Answer"}
read_csv("data/example.csv", col_types = cols(animal = col_character(),
                                              colour = col_skip(),
                                              value = col_double()))

read_csv("data/example.csv", col_types = cols(animal = "c",
                                              colour = "_",
                                              value = "d"))

read_csv("data/example.csv", col_types = "c_d")
```

## Column names{.compact-output}

### The `col_names` argument {.box-6 .bg-blue}

- can be either `TRUE`, `FALSE` or a character vector.
- default value is `TRUE`
- if `TRUE`, the first row will be used as column names
- if `FALSE`, names are generated (X1, X2, X3, ...)
- if it is a character vector, it will define the column names

### Example {.box-6 .bg-green}

```{r, message = FALSE}
read_csv("data/example.csv",
         col_names = TRUE)

read_csv("data/example.csv",
         col_names = FALSE)

read_csv("data/example.csv",
         col_names = c("name", "colname", "number"))
```

## Column names

### Hint {.box-10 .offset-1 .bg-yellow .icon-small}

![](img/00/tip.png)

- `col_names` is handy if they are no column names in the file
- If you would like to rename columns, use `dplyr::rename()` (see upcoming `dplyr` lecture).

```{r, message = FALSE}
read_csv("data/example.csv",
         col_names = c("name", "colname", "number"))

read_csv("data/example.csv", col_names = TRUE) %>%
  rename(name = animal,
         colname = colour,
         number = value)
```


## Skipping lines {.compact-output}

```{css, echo = FALSE}
#skip_example > .r-source:not(:nth-last-child(2)), #skip_example > .r-output:not(:nth-last-child(1)) {
  border-bottom: 2px solid #002240;
  padding-bottom: 10px;
}
```

### `skip` argument {.box-4 .offset-1 .bg-blue}

To skip the first _n_ rows

### `n_max` argument {.box-4 .offset-2 .bg-red}

To stop reading after _n_ rows

### Hint {.box-6 .offset-3 .bg-yellow .icon-small}

![](img/00/tip.png)

You might want to adjust `col_names` to get what you want

%end%

```{r skip_example, message = FALSE, row = c(4, 8)}
readr_example("mtcars.csv") %>%
  read_csv(skip = 3,
           n_max = 3,
           col_names = FALSE)

readr_example("mtcars.csv") %>%
  read_csv(skip = 3, n_max = 3,
           col_names = c("mpg", "cyl", "disp", "hp", "drat", "wt", "qsec", "vs", "am", "gear", "carb"))
```


## `readr` functions {.build}

### `read_csv()`{} {.box-4 .bg-gray}

- **Comma** delimited files

![](img/03/readr_read_csv.png)

### `read_csv2()`{} {.box-4 .bg-gray}

- **Semi-colon** delimited files

![](img/03/readr_read_csv2.png)

### `read_tsv()`{} {.box-4 .bg-gray}

- **tab** delimited files

![](img/03/readr_read_fwf_tsv.png)

### `read_delim()`{} {.box-6 .offset-1 .bg-gray .vs2}

- **any delimiter**:

![](img/03/readr_read_delim.png)

```{r, eval = FALSE}
read_delim(file, delim = "|", ...)
```

### `read_fwf()`{} {.box-4 .bg-gray .vs2 .stretch}

- **fixed width** files

![](img/03/readr_read_fwf_tsv.png)

## Wrap up

### You learned to: {.box-10 .offset-1 .bg-red .icon}

![](img/00/kt.png)

- appreciate the tibble printing features
    + **column types** are displayed
- use `readr` to import your flat file data into _R_
    + using the command line
    + using the interactive RStudio interface
- adjust the imported data types

## Before we stop

### Further reading {.box-8 .offset-2 .bg-blue .icon}

![](img/00/book.png)

- [R for Data Science](http://r4ds.had.co.nz/data-import.html)
- <http://readr.tidyverse.org/>
    + `vignette("readr")`
- [Datacamp course](https://www.datacamp.com/courses/importing-data-in-r-part-1)

### Acknowledgments {.box-8 .offset-2 .vs1 .bg-yellow}

* Hadley Wickham
